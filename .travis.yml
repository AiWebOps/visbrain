language: python


sudo : false
dist: trusty


addons:
  apt:
    packages:
    - &mesa_apt [libgl1-mesa-dri]
    - &full_apt [libegl1-mesa, cmake, xorg-dev, libglu1-mesa-dev, mercurial, libdbus-1-dev, libgl1-mesa-dev, libglu1-mesa-dev, libpulse-dev, libx11-dev, libxcursor-dev, libxext-dev, libxi-dev, libxinerama-dev, libxrandr-dev, libxss-dev, libxt-dev, libxv-dev, libxxf86vm-dev, libasound2-dev, libts-dev, libudev-dev, libsdl2-2.0-0]


matrix:
  include:
    - env: PYTHON=3.6 TEST=standard
      os: linux
    - env: PYTHON=3.6 TEST=minimal
      os: linux
    - env: PYTHON=3.6 TEST=examples
      os: linux
    - env: PYTHON=3.6 TEST=standard
      os: osx
      language: generic


python:
    - "3.6"


before_install:
    - if [ "${TRAVIS_OS_NAME}" == "linux" ]; then
          wget -q http://repo.continuum.io/miniconda/Miniconda-latest-Linux-x86_64.sh -O miniconda.sh;
      else
        wget -q http://repo.continuum.io/miniconda/Miniconda3-latest-MacOSX-x86_64.sh -O miniconda.sh;
      fi;
    - bash miniconda.sh -b -p $HOME/miniconda
    - export PATH="$HOME/miniconda/bin:$PATH"
    - hash -r
    - conda config --set always_yes yes --set changeps1 no
    - conda update -q conda
    - conda info -a
    - SRC_DIR=$(pwd)


install:
    # Install dependencies :
    - conda create -q -n testenv python=$PYTHON numpy scipy matplotlib pip
    - source activate testenv
    - pip install mne nibabel setuptools PyOpenGL PyOpenGL_accelerate pandas
    - pip install -q freetype-py husl pypng cassowary imageio;

    # Install testing librairies :
    - pip install codecov pytest pytest-cov pytest-html

    # ------------------- VISBRAIN -------------------
    - cd ${SRC_DIR}
    - pip install -e .


before_script:
    # Fix screen resolution to 1280x1024x16 :
    - if [ "${TRAVIS_OS_NAME}" = "linux" ]; then
        /sbin/start-stop-daemon --start --quiet --pidfile /tmp/custom_xvfb_99.pid --make-pidfile --background --exec /usr/bin/Xvfb -- :99 -screen 0 1400x900x24 -ac +extension GLX +render;
      fi;
    # - "/sbin/start-stop-daemon --start --quiet --pidfile /tmp/custom_xvfb_99.pid --make-pidfile --background --exec /usr/bin/Xvfb -- :99 -ac -screen 0 1280x1024x16"


script:
    - cd ${SRC_DIR}
    - if [ "${TEST}" == "standard" ]; then
        py.test --cov --verbose;
      fi;
    - if [ "${TEST}" == "examples" ]; then
        ls;
      fi;
    - if [ "${TEST}" == "minimal" ]; then
        ls;
      fi;


cache:
  apt: true


notifications:
    email: false
    slack: visbrainteam:lHdzZcFmXQczGlxJEDtQYqv9


after_success:
  - if [ "${TEST}" == "standard" ]; then
      codecov
    fi;

# screenshot tests are really slow on travis... but installing image librairies
# does't fix it.
# before_install:
#   - sudo apt-get -qq install libfreetype6-dev libjpeg-turbo-progs
# sudo: required
# py.test --cov --verbose --cov-report=html --html=report.html